<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="lib/openlayer/css/ol.css" type="text/css">
    <link rel="stylesheet" href="lib/openlayer/resources/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="lib/openlayer/resources/layout.css" type="text/css">
    <link rel="stylesheet" href="lib/openlayer/resources/bootstrap/css/bootstrap-responsive.min.css" type="text/css">
    <style>
        .map:-moz-full-screen {
            height: 100%;
        }

        .map:-webkit-full-screen {
            height: 100%;
        }

        .map:-ms-fullscreen {
            height: 100%;
        }

        .map:full-screen {
            height: 100%;
        }

        .ol-rotate {
            top: 3em;
        }
    </style>
    <title>Browser # (X,Y)</title>
</head>
<body>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <script src="Scripts/peer.js"></script>
    <script src="signalr/hubs"></script>
    <script>
        var conn;
        var peer;
        var thisBrowserObj;
        connectedPeerIDs = [];
        connectedCount = 0;
        var numBrowsers = 1;
        var C = 156543.034;
        var R = 6378137;
        var peerCoordinateAry = new Array();
        $(function () {
            peer = new Peer({ key: 'x7fwx2kavpy6tj4i', debug: true });

            thisBrowserObj = {};
            thisBrowserObj.browserNum = getUrlVar("num");
            thisBrowserObj.col = getUrlVar("col");
            thisBrowserObj.row = getUrlVar("row");
            thisBrowserObj.numCol = getUrlVar("numCol");
            thisBrowserObj.numRow = getUrlVar("numRow");
            var mapSize = map.getSize();
            thisBrowserObj.height = mapSize[1];
            thisBrowserObj.width = mapSize[0];
            numBrowsers = thisBrowserObj.numCol * thisBrowserObj.numRow;
            document.title = "Browser " + thisBrowserObj.browserNum + "/"+numBrowsers+" (" + thisBrowserObj.col + "," + thisBrowserObj.row + ")";
            var browserInfoAry;
            var browserUpdateObj;
            var browserNumAry = [];
            var peerConnectedAry = [];
            for(i=0;i<parseInt(thisBrowserObj.numRow+1);i++){
                peerCoordinateAry[i]=new Array();
                for(j=0;j<parseInt(thisBrowserObj.numCol+1);j++){
                    peerCoordinateAry[i][j] = -1;
                }
            }
            var networkHub = $.connection.networkHub;
            // ** Receive browser information from server
            networkHub.client.receiveBrowserInfo = function (browserInfo) {

                // browser dropdown menu
                $("#message_to").empty();

                browserInfoAry = JSON.parse(browserInfo);
                $.each(browserInfoAry, function (index, object) {
                    //alert(object.peerId);

                    browserNumAry[object.peerId] = object.browserNum;
                    if (thisBrowserObj.browserNum !== object.browserNum) {

                        if (typeof peerConnectedAry[object.peerId] == 'undefined') {
                            var c = peer.connect(object.peerId);
                            conn = c;
                            c.on('error', function (err) { alert(err) });
                            //c.on('open', function () { connectToPeer(c) });
                            addPeer(object.peerId);
                            peerConnectedAry[object.peerId] = 1;
                            //$("#message_log").append("Row:" +object.row+" Col:"+object.col);
                            peerCoordinateAry[object.row][object.col] = object.peerId;
                        }

                        // browser dropdown menu
                        $("#message_to").append($("<option></option>")
                                            .attr("value", object.peerId)
                                            .text("Browser " + object.browserNum));
                    }
                });
            };
            $.connection.hub.start().done(function () {
                peer.on('open', function (peerId) {
                    thisBrowserObj.peerId = peerId;
                    thisBrowserObj.connectionId = $.connection.hub.id;
                    networkHub.server.sendBrowserInfo(thisBrowserObj);

                    $('#browser_info').append("Col: " + thisBrowserObj.col + " Row: " + thisBrowserObj.row)
                                      .append(" | Height: " + thisBrowserObj.height + " Width: " + thisBrowserObj.width);
                    $('#browser_id').append("BrowserNum: " + thisBrowserObj.browserNum + " | PeerID: " + peerId);
                });
                peer.on('connection', connectToPeer);
            });

            $('#test_btn').click(function () {
                var peerId = $("#message_to option:selected").val();
                conn = peer.connections[peerId][0];
                var msg = $('#test_txt').val();
                conn.send(msg);
            });

            $('#test_json_btn').click(function () {
                var peerId = $("#message_to option:selected").val();
                conn = peer.connections[peerId][0];
                var msg = $('#test_txt').val();

                var jsonData = new Object();
                jsonData.label = "A JSON Test";
                jsonData.type = "data";
                jsonData.value = msg;
                var jsonDataStr = JSON.stringify(jsonData);

                conn.send(jsonDataStr);
            });
            // Converts from degrees to radians.
            Math.radians = function (degrees) {
                return degrees * Math.PI / 180;
            };

            // Converts from radians to degrees.
            Math.degrees = function (radians) {
                return radians * 180 / Math.PI;
            };
            function deg2num(lat_deg, lon_deg, zoom){
                var lat_rad = Math.radians(lat_deg);
                var n = Math.pow(2.0, zoom);
                var xtile = parseInt(((lon_deg + 180.0) / 360.0 * n), 10);
                var ytile = parseInt((1.0 - Math.log(Math.tan(lat_rad) + (1 / Math.cos(lat_rad))) / Math.PI) / 2.0 * n);
                return [xtile, ytile];
            }
            function num2deg(xtile,ytile,zoom){
                var n = Math.pow(2.0, zoom);
                var lon_deg = xtile / n * 360.0 - 180.0;
                var lat_rad = Math.atan(Math.sinh(Math.PI * (1 - 2 * ytile / n)));
                var lat_deg = Math.degrees(lat_rad);
                return [lat_deg, lon_deg];
            }
            function connectToPeer(c) {
                var conn = c;
                $("#message_log").append("Browser " + browserNumAry[conn.peer] + " is connected. ID: " + conn.peer + "&#10;");
                conn.on('data', function (data) {
                    $("#message_log").append("Browser " + browserNumAry[conn.peer] + " says: " + data + "&#10;");
                    if (thisBrowserObj.browserNum > 0) {
                        var sLon = data[0];
                        var sLat = data[1];
                        $("#message_log").append("sLat , sLon: " + sLat + "," + sLon + "&#10;");
                        var sCenter = [sLon, sLat];
                        var sResolution = data[2];
                        $("#message_log").append("sResolution: " + sResolution + "&#10;");
                        /*var sZoom = data[3];
                        $("#message_log").append("sZoom: " + sZoom + "&#10;");
                        //var sCen = num2deg(data[0], data[1],sZoom);
                        var sWidth = data[4];
                        var sHeight = data[5];
                        $("#message_log").append("sWidth , sHeight: " + sWidth + "," + sHeight + "&#10;");
                        var sPixel = Math.abs(C * Math.cos(sLat) / Math.pow(2,(sZoom)));
                        $("#message_log").append("sPixel: " + sPixel + "&#10;");
                        $("#message_log").append("sNumRow: " + thisBrowserObj.numRow + "&#10;");
                        $("#message_log").append("sNumCol: " + thisBrowserObj.numCol + "&#10;");
                        var numScreens = (parseInt(thisBrowserObj.numRow) + parseInt(thisBrowserObj.numCol));
                        $("#message_log").append("numScreens: " + numScreens + "&#10;");
                        var uWidth = (sWidth / thisBrowserObj.numRow);
                        var uHeight = (sHeight / thisBrowserObj.numCol);
                        $("#message_log").append("uWidth , uHeight: " + uWidth + "," + uHeight + "&#10;");
                        var rResolution = sResolution / (numScreens/2);
                        //var rResolution = sResolution / ((sWidth) / (uWidth));
                        $("#message_log").append("rResolution: " + rResolution + "&#10;");
                        var rWidth = (uWidth * thisBrowserObj.row) - (uWidth / 2);
                        var rHeight = (uHeight * thisBrowserObj.col) - (uHeight / 2);
                        $("#message_log").append("rWidth , rHeight: " + rWidth + "," + rHeight + "&#10;");
                        var dn = sPixel * ( (sHeight / 2) - rHeight);
                        var de = sPixel * (rWidth - (sWidth / 2));
                        var dLat = (dn / R) * 180 / Math.PI;
                        var dLon = (de / (R * Math.cos(sLat * Math.PI /180 ))) * 180 / Math.PI;
                        $("#message_log").append("dLat , dLon: " + dLat + "," + dLon + "&#10;");
                        var rLat = sLat + dLat ;
                        var rLon = sLon + dLon ;
                        $("#message_log").append("rLat , rLon: " + rLat + "," + rLon + "&#10;");
                        //var center = deg2num(rLat,rLon,sZoom);
                        var center = [rLon,rLat];*/
                        map.getView().setCenter(sCenter);
                        //map.getView().setCenter(ol.proj.transform(center, 'EPSG:4326', 'EPSG:3857'));
                        //map.getView().setZoom(zoom);
                        //map.getView().setResolution(rResolution);
                        map.getView().setResolution(sResolution);
                    }
                });
                conn.on('close', function (err) {
                    $("#message_log").append("Browser " + browserNumAry[conn.peer] + " is disconnected. ID: " + conn.peer + "&#10;");
                    //delete peerConnectedAry[conn.peer];
                    delete browserNumAry[conn.peer];
                    removePeer(conn.peer);
                });
            }
        });
        function addPeer(peerID) {
            var found = 0;
            for (i = 0; i < connectedCount; i++) {
                if (connectedPeerIDs[i] == peerID) {
                    found = 1;
                }
            }
            if (found == 0) {
                connectedPeerIDs[connectedCount] = peerID;
                connectedCount++;
            }
        }
        function removePeer(peerID) {
            for (i = 0; i < connectedCount; i++) {
                if (connectedPeerIDs[i] == peerID) {
                    connectedPeerIDs.splice(i, 1);
                    connectedCount--;
                }
            }
        }
        function getUrlVar(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) { return pair[1]; }
            }
            return (false);
        }
    </script>

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span12">
                <div id="map" class="map"></div>
            </div>
        </div>
    </div>
    <div id="browser_info"></div>
    <br />
    <div id="browser_id"></div>
    <select id="message_to">
        <option>Loading..</option>
    </select>
    <input type="text" id="test_txt" />
    <input type="button" id="test_btn" value="Send" />
    <input type="button" id="test_json_btn" value="SendJSON" />
    <br /><br />
    <textarea style="width: 70%;" rows="7" id="message_log"></textarea>
    <script src="lib/openlayer/resources/example-behaviour.js" type="text/javascript"></script>
    <script src="scripts/ol.loader.js?id=fullscreen" type="text/javascript"></script>
    <script type="text/javascript">

        function sendSUpdatetoPeer(peerId, x, y, resolution, zoom, width, height) {
            try {
                var peerId = peerId;
                conn = peer.connections[peerId][0];
                conn.send([x, y, resolution, zoom, width, height]);
            }
            catch (err) {
            }
        };
        function sendRUpdatetoPeer(peerId, x, y, resolution) {
            try {
                var peerId = peerId;
                conn = peer.connections[peerId][0];
                conn.send([x, y, resolution]);
            }
            catch (err) {
            }
        };
        function sendUpdateAll(x, y, resolution, zoom, width, height) {
            //calculate new resolution
            var numBrowsers = (parseInt(thisBrowserObj.numRow) + parseInt(thisBrowserObj.numCol));
            var uWidth = (width / thisBrowserObj.numRow);
            var uHeight = (height / thisBrowserObj.numCol);
            var rResolution = resolution / (numBrowsers / 2);
            /*for (i = 0; i < connectedCount; i++) {
                sendUpdatetoPeer(connectedPeerIDs[i], x, y, resolution, zoom, width, height);
            }*/

            for (i = 1; i < thisBrowserObj.numRow+1; i++) {
                for (j = 1; j < thisBrowserObj.numCol+1; j++) {
                    var newCenter = map.getCoordinateFromPixel([(((i-1) * uWidth) + (uWidth / 2)), (((j-1) * uHeight) + (uHeight / 2))]);
                    var peerID = peerCoordinateAry[i][j];
                    if (peerID != -1) {
                        //$("#message_log").append("PeerID" + peerID + "&#10;");
                        sendRUpdatetoPeer(peerID, newCenter[0],newCenter[1],rResolution);
                    }
                }
            }
        }
        function changeEvent() {
            if (thisBrowserObj.browserNum == 0) {
                //var center = ol.proj.transform(map.getView().getCenter(), 'EPSG:3857', 'EPSG:4326');
                var center = map.getView().getCenter();
                var zoom = map.getView().getZoom();
                var resolution = map.getView().getResolution();
                var size = map.getSize();
                var width = size[0];
                var height = size[1];
                //$("#message_log").append("" + center[0] + "," + center[1] + "," + resolution + "&#10;");
                sendUpdateAll(center[0], center[1], resolution, zoom, width, height);

            }
        }
        map.getView().on('change:resolution', function () {
            changeEvent();
        });
        map.getView().on('change:center', function () {
            changeEvent();
        });
        map.getView().on('change:rotation', function () {
            changeEvent();
        });
        map.getView().on('change:size', function () {
            changeEvent();
        });
        map.getView().on('change:view', function () {
            changeEvent();
        });
        map.getView().on('change:zoom', function () {
            changeEvent();
        });
        map.getView().on('change:target', function () {
            changeEvent();
        });
    </script>
</body>
</html>
