<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ICave Hub</title>
</head>
<body>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <script src="Scripts/peer.js"></script>
    <script src="signalr/hubs"></script>
    <script>
        $(function () {

            var conn;
            var peer = new Peer({ key: 'x7fwx2kavpy6tj4i', debug: true });

            var thisBrowserObj = {};
            thisBrowserObj.browserNum = "Hub";
            thisBrowserObj.col = 0;
            thisBrowserObj.row = 0;
            thisBrowserObj.numRow = getUrlVar("numRow");
            thisBrowserObj.numCol = getUrlVar("numCol");
            thisBrowserObj.height = $(window).height();
            thisBrowserObj.width = $(window).width();

            drawBrowserTable(thisBrowserObj.numRow, thisBrowserObj.numCol); // (row, col)

            var browserInfoAry;
            var browserNumAry = [];
            var peerConnectedAry = [];

            var networkHub = $.connection.networkHub;

            // ** Receive browser information from server
            networkHub.client.receiveBrowserInfo = function (browserInfo) {

                // browser dropdown menu
                $("#message_to").empty();

                browserInfoAry = JSON.parse(browserInfo);
                $.each(browserInfoAry, function (index, object) {
                    //alert(object.peerId);

                    // browser table content
                    if ($("#" + object.peerId).length === 0) { // (null)
                        $("#browser_table tr:nth-child(" + object.row + ") td:nth-child(" + object.col + ")")
                            .empty()
                            .css("background", "white")
                            .append("<br/>Col: " + object.col + " | Row: " + object.row)
                            .append("<br/>Height: " + object.height + " | " + "Width: " + object.width)
                            .append("<br/><br/>BrowserNum: " + object.browserNum)
                            .append("<br/><div id='" + object.peerId + "'> PeerID: " + object.peerId + "</div>")
                            .append("<br/><br/><div id='message_from_" + object.browserNum + "'></div>");
                    }

                    // highlight this browser
                    if (thisBrowserObj.browserNum === object.browserNum) {
                        $("#browser_table tr:nth-child(" + object.row + ") td:nth-child(" + object.col + ")").css("background", "#E2F4F6");
                    }else {
                        $("#browser_table tr:nth-child(" + object.row + ") td:nth-child(" + object.col + ")").click(function() {
                            $("#message_to").val(object.peerId);
                            // highlight dropdown menu
                            $("#message_to").css("background", "lightpink");
                            setTimeout(function() {
                                $("#message_to").css("background", "");
                            },300);
                        });
                    }

                    browserNumAry[object.peerId] = object.browserNum;
                    if (thisBrowserObj.browserNum !== object.browserNum) {

                        if (typeof peerConnectedAry[object.peerId] == 'undefined') {
                            var c = peer.connect(object.peerId);
                            conn = c;
                            c.on('error', function (err) { alert(err) });
                            //c.on('open', function () { connectToPeer(c) });

                            peerConnectedAry[object.peerId] = 1;
                        }
                        
                        // browser dropdown menu
                        $("#message_to").append($("<option></option>")
                                            .attr("value", object.peerId)
                                            .text("Browser " + object.browserNum));
                    }
                });
            };

            $.connection.hub.start().done(function () {
                peer.on('open', function (peerId) {
                    thisBrowserObj.peerId = peerId;
                    thisBrowserObj.connectionId = $.connection.hub.id;
                    networkHub.server.sendBrowserInfo(thisBrowserObj);

                    // ** BACK
                    //$('#browser_info').append("Col: " + thisBrowserObj.col + " Row: " + thisBrowserObj.row)
                    //                  .append(" | Height: " + thisBrowserObj.height + " Width: " + thisBrowserObj.width);
                    //$('#browser_id').append("BrowserNum: " + thisBrowserObj.browserNum + " | PeerID: " + peerId);
                });
                peer.on('connection', connectToPeer);
            });

            $('#test_btn').click(function () {
                var peerId = $("#message_to option:selected").val();
                conn = peer.connections[peerId][0];
                var msg = $('#test_txt').val();

                conn.send(msg);

                $("#message_from_" + thisBrowserObj.browserNum).append("To " + $("#message_to option:selected").text() + ": " + msg + "<br/>");
            });

            $('#test_json_btn').click(function () {
                var peerId = $("#message_to option:selected").val();
                conn = peer.connections[peerId][0];
                var msg = $('#test_txt').val();

                var jsonData = new Object();
                jsonData.label = "A JSON Test";
                jsonData.type = "data";
                jsonData.value = msg;
                var jsonDataStr = JSON.stringify(jsonData);

                conn.send(jsonDataStr);

                $("#message_from_" + thisBrowserObj.browserNum).append("To " + $("#message_to option:selected").text() + ": " + jsonDataStr + "<br/>");
            });
            
            function connectToPeer(c) {
                var conn = c;
                $("#message_log").append("Browser " + browserNumAry[conn.peer] + " is connected. ID: " + conn.peer + "<br/>");
                conn.on('data', function (data) {
                    // $("#message_log").append("Browser " + browserNumAry[conn.peer] + " says: " + data + "<br/>");
                    $("#message_from_" + browserNumAry[conn.peer]).append("Browser " + browserNumAry[conn.peer] + " says: " + data + "<br/>");
                });
                conn.on('close', function (err) {
                    $("#message_log").append("Browser " + browserNumAry[conn.peer] + " is disconnected. ID: " + conn.peer + "<br/>");
                    $("#message_from_" + browserNumAry[conn.peer]).parent().css("background", "#E9E9E9");
                    delete peerConnectedAry[conn.peer];
                    delete browserNumAry[conn.peer];
                });
            }
        });

        function drawBrowserTable(maxRow, maxCol) {
            $("#browser_table").empty();
            for (var i = 0; i < maxRow; i++) {
                $("#browser_table").append("<tr></tr>");
                for (var j = 0; j < maxCol; j++) {
                    $("#browser_table tr:last").append("<td>(" + (i+1) + "," + (j+1) + ")</td>");
                }
            }
        }

        function getUrlVar(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) { return pair[1]; }
            }
            return (false);
        }
    </script>

    <style>
        td {
            width: 10%;
            height: 200px;
            border: solid 1px black;
        }
        
        .active {
            background: lightpink;
        }
    </style>

    <table id="browser_table" style="width:100%">
        <tr>
            <td>(1,1)</td>
            <td>(1,2)</td>
        </tr>
        <tr>
            <td>(2,1)</td>
            <td>(2,2)</td>
        </tr>
    </table>
    <br/>
    <select id="message_to">
        <option>Loading..</option>
    </select>
    <input type="text" id="test_txt"/>
    <input type="button" id="test_btn" value="Send" />
    <input type="button" id="test_json_btn" value="SendJSON" />
    <br/><br/>
    <div id="message_log"></div>
    http://localhost:12332/node.html?num=1&col=1&row=2&numCol=2&numRow=2
</body>
</html>
